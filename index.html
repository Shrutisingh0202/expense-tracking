<!DOCTYPE html>
<html lang="en"> <!-- "dark" class will be added here dynamically -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA - Expense Tracker (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/customParseFormat.min.js"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #fff7ed; /* orange-50 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #fee2e2; /* red-100 */
            --text-primary: #7c2d12; /* orange-900 */
            --text-secondary: #9a3412; /* orange-800 */
            --text-gradient-from: #f97316; /* orange-500 */
            --text-gradient-to: #dc2626; /* red-600 */
            --border-color: #fca5a5; /* red-300 */
            --gradient-main-from: #fed7aa; /* orange-200 */
            --gradient-main-to: #fecaca; /* red-200 */
        }

        html.dark {
            --bg-primary: #1c1917; /* stone-900 */
            --bg-secondary: #292524; /* stone-800 */
            --bg-tertiary: #44403c; /* stone-700 */
            --text-primary: #ffedd5; /* orange-100 */
            --text-secondary: #fed7aa; /* orange-200 */
            --text-gradient-from: #fb923c; /* orange-400 */
            --text-gradient-to: #f87171; /* red-400 */
            --border-color: #57534e; /* stone-600 */
            --gradient-main-from: #7c2d12; /* orange-900 */
            --gradient-main-to: #7f1d1d; /* red-900 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-gradient-main {
            background: linear-gradient(135deg, var(--gradient-main-from) 0%, var(--gradient-main-to) 100%);
        }
        .text-gradient {
            background: linear-gradient(135deg, var(--text-gradient-from) 0%, var(--text-gradient-to) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-gradient {
            background-image: linear-gradient(to right, #f97316 0%, #ef4444 51%, #f97316 100%);
            background-size: 200% auto;
            transition: 0.5s;
        }
        .btn-gradient:hover {
            background-position: right center;
        }
        .btn-gradient:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #fca5a5; border-radius: 4px; }
        html.dark ::-webkit-scrollbar-thumb { background: #7c2d12; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        
        .card {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-color);
        }
        .nav-link.active {
            background-color: var(--text-gradient-from);
            color: white;
        }
    </style>
</head>
<body>

    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center bg-gradient-main p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-5xl font-bold text-gradient mb-2">AURA</h1>
                <p class="text-orange-800 dark:text-orange-200">Your Personal & Social Finance Tracker</p>
            </div>
            <div class="bg-white/50 dark:bg-stone-800/50 backdrop-blur-sm p-8 rounded-2xl shadow-2xl">
                <form id="auth-form">
                    <h2 id="auth-title" class="text-2xl font-bold text-center mb-6 text-stone-900 dark:text-white">Login</h2>
                    <p id="auth-error" class="text-red-500 text-center text-sm mb-4 h-5"></p>
                    <div class="space-y-4">
                        <input type="email" id="auth-email" placeholder="Email" class="w-full bg-[--bg-tertiary] text-[--text-primary] rounded-lg p-3 focus:ring-2 focus:ring-orange-500 focus:outline-none" required>
                        <input type="password" id="auth-password" placeholder="Password" class="w-full bg-[--bg-tertiary] text-[--text-primary] rounded-lg p-3 focus:ring-2 focus:ring-orange-500 focus:outline-none" required>
                    </div>
                    <div class="mt-6 space-y-2">
                         <button type="submit" id="auth-submit-btn" class="w-full text-white rounded-lg p-3 text-lg font-semibold btn-gradient">Login</button>
                    </div>
                </form>
                <p class="text-center text-sm mt-4 text-stone-600 dark:text-stone-400">
                    <span id="auth-toggle-text">Don't have an account?</span>
                    <button id="auth-toggle-btn" class="font-semibold text-orange-600 dark:text-orange-400 hover:underline">Sign Up</button>
                </p>
            </div>
        </div>
    </div>


    <!-- Main App -->
    <div id="app-screen" class="hidden">
        <div class="max-w-7xl mx-auto p-4 relative">
            <!-- Header -->
            <header class="flex flex-wrap justify-between items-center gap-4 mb-6">
                <h1 class="text-4xl font-bold text-gradient">AURA</h1>
                <div class="flex items-center gap-4">
                     <button id="theme-toggle-btn" class="p-2 rounded-lg bg-[--bg-secondary] border border-[--border-color]">
                        <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    </button>
                    <button id="nav-toggle" class="md:hidden p-2 rounded-lg bg-[--bg-secondary] border border-[--border-color]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>
                </div>
            </header>

            <div class="flex flex-col md:flex-row gap-6">
                <!-- Navigation -->
                <nav id="nav-menu" class="w-full md-w-56 card rounded-xl p-4 flex-shrink-0 hidden md:block">
                    <ul class="space-y-2">
                        <li><a href="#" class="nav-link active block rounded-md px-3 py-2" data-target="dashboard">Dashboard</a></li>
                        <li><a href="#" class="nav-link block rounded-md px-3 py-2" data-target="jars">Joint Jars</a></li>
                        <li><a href="#" class="nav-link block rounded-md px-3 py-2" data-target="friends">Friends</a></li>
                        <li><a href="#" class="nav-link block rounded-md px-3 py-2" data-target="data-management">Data</a></li>
                    </ul>
                    <div class="mt-6 pt-4 border-t border-[--border-color]">
                        <p class="text-xs text-[--text-secondary] mb-2">Your User ID:</p>
                        <div class="flex items-center bg-[--bg-primary] p-2 rounded-lg">
                           <input id="user-id-display" type="text" readonly class="text-xs text-[--text-primary] bg-transparent w-full outline-none" value="loading...">
                           <button id="copy-user-id" class="p-1 text-[--text-secondary] hover:text-[--text-primary]">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                           </button>
                        </div>
                         <p id="copy-feedback" class="text-xs text-green-500 mt-1 h-4"></p>
                         <button id="sign-out-btn" class="w-full text-left text-sm text-red-500 hover:text-red-700 dark:hover:text-red-400 mt-4 p-2 rounded-md hover:bg-red-100 dark:hover:bg-red-900/50">Sign Out</button>
                    </div>
                </nav>

                <!-- Main Content -->
                <main class="flex-1">
                    <!-- Dashboard -->
                    <div id="dashboard" class="page-content">
                        <!-- Add Transaction Form -->
                        <div class="card p-4 rounded-xl mb-6">
                            <h2 class="text-xl font-bold mb-4">Add Transaction</h2>
                            <form id="add-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label for="add-description" class="block text-sm font-medium text-[--text-secondary] mb-1">Description</label>
                                    <input type="text" id="add-description" class="w-full bg-[--bg-tertiary] text-[--text-primary] rounded-lg p-2 focus:ring-2 focus:ring-orange-500 focus:outline-none" required>
                                </div>
                                <div>
                                    <label for="add-amount" class="block text-sm font-medium text-[--text-secondary] mb-1">Amount (₹)</label>
                                    <input type="number" id="add-amount" step="0.01" class="w-full bg-[--bg-tertiary] text-[--text-primary] rounded-lg p-2 focus:ring-2 focus:ring-orange-500 focus:outline-none" required>
                                </div>
                                <div>
                                    <label for="add-date" class="block text-sm font-medium text-[--text-secondary] mb-1">Date</label>
                                    <input type="text" id="add-date" placeholder="DD/MM/YYYY" class="w-full bg-[--bg-tertiary] text-[--text-primary] rounded-lg p-2 focus:ring-2 focus:ring-orange-500 focus:outline-none" required>
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-[--text-secondary] mb-1">Payment Method</label>
                                    <select id="add-method" class="w-full bg-[--bg-tertiary] text-[--text-primary] rounded-lg p-2 focus:ring-2 focus:ring-orange-500 focus:outline-none"><option value="Online">Online</option><option value="Cash">Cash</option></select>
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-[--text-secondary] mb-1">Type</label>
                                    <select id="add-type" class="w-full bg-[--bg-tertiary] text-[--text-primary] rounded-lg p-2 focus:ring-2 focus:ring-orange-500 focus:outline-none"><option value="expense">Expense</option><option value="income">Income</option></select>
                                </div>
                                <div class="md:col-span-2">
                                     <button type="submit" class="w-full text-white rounded-lg p-2 btn-gradient h-10 mt-2">Add Transaction</button>
                                </div>
                            </form>
                            <p id="add-feedback" class="text-xs text-green-500 mt-2 h-4"></p>
                        </div>

                        <!-- Month Navigator -->
                        <div class="flex justify-between items-center mb-4 card p-2 rounded-xl">
                            <button id="prev-month-btn" class="p-2 rounded-md hover:bg-[--bg-tertiary]"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <h2 id="month-display" class="text-xl font-bold text-center cursor-pointer" title="Go to a specific date">September 2025</h2>
                            <button id="next-month-btn" class="p-2 rounded-md hover:bg-[--bg-tertiary]"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                        </div>
                        
                        <!-- Summary Boxes -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                           <div class="card p-4 rounded-xl bg-gradient-main">
                                <h3 class="text-sm text-orange-900 dark:text-orange-100 mb-1">Total Opening Balance</h3>
                                <p id="opening-balance" class="text-2xl font-bold text-slate-800 dark:text-white">₹0.00</p>
                           </div>
                           <div class="card p-4 rounded-xl bg-gradient-main">
                                <h3 class="text-sm text-orange-900 dark:text-orange-100 mb-1">Total Closing Balance</h3>
                                <p id="closing-balance" class="text-2xl font-bold text-slate-800 dark:text-white">₹0.00</p>
                           </div>
                           <div class="card p-4 rounded-xl">
                                <h3 class="text-sm text-[--text-secondary] mb-1">Gains</h3>
                                <p id="monthly-gains" class="text-2xl font-bold text-green-500">₹0.00</p>
                           </div>
                           <div class="card p-4 rounded-xl">
                                <h3 class="text-sm text-[--text-secondary] mb-1">Expense</h3>
                                <p id="monthly-expense" class="text-2xl font-bold text-red-500">₹0.00</p>
                           </div>
                            <div class="card p-4 rounded-xl">
                                <h3 class="text-sm text-[--text-secondary] mb-1">Cash Balance</h3>
                                <p id="cash-balance" class="text-2xl font-bold">₹0.00</p>
                           </div>
                            <div class="card p-4 rounded-xl">
                                <h3 class="text-sm text-[--text-secondary] mb-1">Online Balance</h3>
                                <p id="online-balance" class="text-2xl font-bold">₹0.00</p>
                           </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <h2 id="transactions-title" class="text-2xl font-bold mb-4">Transactions This Month</h2>
                            <button id="back-to-month-btn" class="hidden text-sm text-orange-600 hover:underline mb-4">Show Full Month</button>
                        </div>
                        <div id="transactions-list" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2">
                           <p id="no-transactions" class="text-[--text-secondary] text-center py-8">No transactions this month.</p>
                        </div>
                    </div>

                    <!-- Other Pages -->
                     <div id="jars" class="page-content hidden card p-6 rounded-xl"><h2 class="text-2xl font-bold">Joint Jars</h2><p class="text-[--text-secondary] mt-4">Feature coming soon!</p></div>
                    <div id="friends" class="page-content hidden card p-6 rounded-xl"><h2 class="text-2xl font-bold">Friends</h2><p class="text-[--text-secondary] mt-4">Feature coming soon!</p></div>
                    <div id="data-management" class="page-content hidden card p-6 rounded-xl">
                        <h2 class="text-2xl font-bold mb-4">Data Management</h2>
                        <div class="space-y-6">
                            <!-- Import -->
                            <div>
                                <h3 class="text-lg font-semibold mb-2">Import Data</h3>
                                <p class="text-sm text-[--text-secondary] mb-3">Import transactions and monthly summaries from a JSON file. This will update existing entries and add new ones.</p>
                                <div class="flex items-center gap-4">
                                    <input type="file" id="import-file-input" accept=".json" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100"/>
                                    <button id="import-btn" class="px-4 py-2 rounded-lg btn-gradient text-white font-semibold flex-shrink-0">Import</button>
                                </div>
                                <p id="import-feedback" class="text-sm mt-2 h-5"></p>
                            </div>
                            <!-- Export -->
                            <div>
                                <h3 class="text-lg font-semibold mb-2">Export Data</h3>
                                <p class="text-sm text-[--text-secondary] mb-3">Export all of your transactions and monthly summaries to a JSON backup file.</p>
                                <button id="export-btn" class="px-4 py-2 rounded-lg btn-gradient text-white font-semibold">Export All My Data</button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Date Picker Modal -->
    <div id="date-picker-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="card p-6 rounded-xl w-full max-w-sm m-4">
            <h3 class="text-xl font-bold mb-4">Go to Date</h3>
            <form id="date-picker-form">
                <input type="date" id="date-picker-input" class="w-full bg-[--bg-tertiary] text-[--text-primary] rounded-lg p-2 focus:ring-2 focus:ring-orange-500 focus:outline-none mb-4" required>
                <div class="flex justify-end gap-2">
                    <button type="button" id="date-picker-cancel" class="px-4 py-2 rounded-lg hover:bg-[--bg-tertiary]">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-lg btn-gradient text-white font-semibold">Go</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Detail/Delete Modal -->
    <div id="transaction-detail-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="card p-6 rounded-xl w-full max-w-sm m-4">
            <h3 class="text-xl font-bold mb-4">Transaction Details</h3>
            <div id="transaction-detail-content" class="space-y-2 mb-6 text-sm">
                <!-- Details will be populated here by JS -->
            </div>
            <div class="flex justify-between gap-2">
                <button type="button" id="transaction-detail-delete" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold">Delete</button>
                <button type="button" id="transaction-detail-close" class="px-4 py-2 rounded-lg hover:bg-[--bg-tertiary]">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="card p-6 rounded-xl w-full max-w-sm m-4">
            <h3 class="text-xl font-bold mb-4">Are you sure?</h3>
            <p class="text-[--text-secondary] mb-6">This action cannot be undone. The transaction will be permanently deleted.</p>
            <div class="flex justify-end gap-2">
                <button type="button" id="delete-confirm-cancel" class="px-4 py-2 rounded-lg hover:bg-[--bg-tertiary]">Cancel</button>
                <button type="button" id="delete-confirm-btn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold">Yes, Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        const { createClient } = supabase;

        // --- GLOBAL CONFIG & STATE ---
        const supabaseUrl = 'https://ahdsjmblyfklicnjlndt.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZHNqbWJseWZrbGljbmpsbmR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODIzMjIsImV4cCI6MjA3Mzk1ODMyMn0.jyoK7mllXzd6NXh5bJOIoJVT3MTyzqbu7M5YKQKpyMo';
        
        let supabaseClient, user = null, transactionChannel = null;
        let transactionsCache = [];
        let currentDisplayDate = dayjs();
        let isLoginMode = true;
        let viewScope = 'month'; // 'month' or 'day'
        let transactionToDeleteId = null;
        
        dayjs.extend(dayjs_plugin_customParseFormat);
        
        const monthDisplay = document.getElementById('month-display');
        
        // --- THEME MANAGEMENT --- (Unchanged)
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            const isDark = theme === 'dark';
            document.documentElement.classList.toggle('dark', isDark);
            document.getElementById('theme-icon-light').classList.toggle('hidden', isDark);
            document.getElementById('theme-icon-dark').classList.toggle('hidden', !isDark);
        }
        themeToggleBtn.addEventListener('click', () => setTheme(localStorage.getItem('theme') === 'dark' ? 'light' : 'dark'));
        setTheme(localStorage.getItem('theme') || 'light');

        // --- INITIALIZATION ---
        function initializeSupabase() {
            if (!supabaseUrl.startsWith('https://') || !supabaseKey.startsWith('ey')) {
                 document.getElementById('auth-error').textContent = 'Supabase credentials are not set.';
                 return;
            }
            try {
                supabaseClient = createClient(supabaseUrl, supabaseKey);
                setupAuthObserver();
            } catch (error) { console.error("Supabase init failed:", error); }
        }
        
        async function setupAuthObserver() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            handleUserSession(session);

            supabaseClient.auth.onAuthStateChange((_event, session) => {
                handleUserSession(session);
            });
        }
        
        async function handleUserSession(session) {
            console.log("DEBUG: Handling user session...");
            const authScreen = document.getElementById('auth-screen');
            const appScreen = document.getElementById('app-screen');
            user = session?.user || null;

            if (user) {
                console.log("DEBUG: User found:", user.id);
                document.getElementById('user-id-display').value = user.id;
                if (authScreen) authScreen.classList.add('hidden');
                if (appScreen) appScreen.classList.remove('hidden');
                console.log("DEBUG: App screen shown. Fetching initial transactions...");
                await fetchInitialTransactions();
                console.log("DEBUG: Initial transactions fetched. Listening for changes...");
                listenToTransactions();
            } else {
                console.log("DEBUG: No user session found.");
                if (transactionChannel) transactionChannel.unsubscribe();
                transactionsCache = []; 
                if (appScreen) appScreen.classList.add('hidden');
                if (authScreen) authScreen.classList.remove('hidden');
            }
        }
        
        // --- AUTH FORM LOGIC ---
        const authForm = document.getElementById('auth-form');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleText = document.getElementById('auth-toggle-text');
        const authError = document.getElementById('auth-error');

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            authError.textContent = '';
            authForm.reset();
            authTitle.textContent = isLoginMode ? 'Login' : 'Sign Up';
            authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Create Account';
            authToggleText.textContent = isLoginMode ? "Don't have an account?" : 'Already have an account?';
            authToggleBtn.textContent = isLoginMode ? 'Sign Up' : 'Login';
        }
        
        authToggleBtn.addEventListener('click', toggleAuthMode);

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            let response;
            authSubmitBtn.disabled = true;
            authSubmitBtn.textContent = isLoginMode ? 'Logging in...' : 'Creating Account...';

            try {
                if (isLoginMode) {
                    response = await supabaseClient.auth.signInWithPassword({ email, password });
                } else {
                    response = await supabaseClient.auth.signUp({ email, password });
                }
                if (response.error) throw response.error;
            } catch (error) {
                if (error.message.includes('For security purposes')) {
                    authError.textContent = 'You are trying too frequently. Please wait a minute.';
                } else {
                    authError.textContent = error.message;
                }
                console.error("Auth Error: ", error);
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Create Account';
            }
        });
        
        document.getElementById('sign-out-btn').addEventListener('click', () => supabaseClient.auth.signOut());


        // --- NAVIGATION LOGIC ---
        const navToggle = document.getElementById('nav-toggle');
        const navMenu = document.getElementById('nav-menu');
        const navLinks = document.querySelectorAll('.nav-link');
        const pageContents = document.querySelectorAll('.page-content');
        navToggle.addEventListener('click', () => navMenu.classList.toggle('hidden'));
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.dataset.target;
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                pageContents.forEach(content => content.classList.toggle('hidden', content.id !== targetId));
                if (window.innerWidth < 768) { navMenu.classList.add('hidden'); }
            });
        });

        // --- DATA LOGIC ---
        async function fetchInitialTransactions() {
            if (!user) return;
            console.log("DEBUG: Fetching transactions from Supabase...");
            const { data, error } = await supabaseClient
                .from('transactions')
                .select('*')
                .eq('user_id', user.id);
            if (error) {
                console.error("Error fetching initial transactions:", error);
            } else {
                transactionsCache = data || [];
                console.log(`DEBUG: Found ${transactionsCache.length} transactions. Updating dashboard view...`);
                await updateDashboardView();
            }
        }

        function listenToTransactions() {
            if (transactionChannel) transactionChannel.unsubscribe();
            if (!user) return;
            
            transactionChannel = supabaseClient.channel('public:transactions')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'transactions', filter: `user_id=eq.${user.id}` }, 
                (payload) => {
                    fetchInitialTransactions();
                })
                .subscribe();
        }

        // --- DASHBOARD VIEW LOGIC ---
        async function getStartingBalancesForMonth(monthDate, depth = 0) {
            if (depth > 60) {
                console.warn("Reached recursion limit for balance calculation. Assuming zero.");
                return { cash: 0, online: 0 };
            }

            if (!user) return { cash: 0, online: 0 };
            const monthKey = monthDate.format('YYYY-MM');

            const { data, error } = await supabaseClient
                .from('monthly_summaries')
                .select('startingCash, startingOnline')
                .eq('user_id', user.id)
                .eq('month_key', monthKey)
                .single();

            if (data) {
                return { cash: data.startingCash || 0, online: data.startingOnline || 0 };
            }
            
            if(error && error.code !== 'PGRST116'){
                console.error(`Error fetching summary for ${monthKey}:`, error);
            }

            const prevMonthDate = monthDate.subtract(1, 'month');
            const prevMonthStartBalances = await getStartingBalancesForMonth(prevMonthDate, depth + 1);
            
            const prevMonthTransactions = transactionsCache.filter(tx => 
                dayjs(tx.date, 'DD/MM/YYYY').isSame(prevMonthDate, 'month')
            );

            let prevMonthCashFlow = 0;
            let prevMonthOnlineFlow = 0;
            prevMonthTransactions.forEach(tx => {
                const amount = tx.type === 'income' ? tx.amount : -tx.amount;
                if (tx.method?.toLowerCase() === 'cash') prevMonthCashFlow += amount;
                else prevMonthOnlineFlow += amount;
            });
            
            return {
                cash: prevMonthStartBalances.cash + prevMonthCashFlow,
                online: prevMonthStartBalances.online + prevMonthOnlineFlow
            };
        }
        
        async function updateDashboardView() {
            if (!user) return; 
            console.log("DEBUG: Updating dashboard view...");
            const transactionsTitle = document.getElementById('transactions-title');
            const backToMonthBtn = document.getElementById('back-to-month-btn');

            let transactionsToRender;
            
            if (viewScope === 'day') {
                monthDisplay.textContent = currentDisplayDate.format('D MMMM YYYY');
                transactionsTitle.textContent = `Transactions for ${currentDisplayDate.format('D MMM')}`;
                backToMonthBtn.classList.remove('hidden');
                transactionsToRender = transactionsCache.filter(tx => dayjs(tx.date, 'DD/MM/YYYY').isSame(currentDisplayDate, 'day'));
            } else { // month view
                monthDisplay.textContent = currentDisplayDate.format('MMMM YYYY');
                transactionsTitle.textContent = 'Transactions This Month';
                backToMonthBtn.classList.add('hidden');
                transactionsToRender = transactionsCache.filter(tx => dayjs(tx.date, 'DD/MM/YYYY').isSame(currentDisplayDate, 'month'));
            }

            const monthForSummary = currentDisplayDate.startOf('month');
            const startBalances = await getStartingBalancesForMonth(monthForSummary);
            console.log("DEBUG: Calculated start balances:", startBalances);

            const monthlyTransactions = transactionsCache.filter(tx => dayjs(tx.date, 'DD/MM/YYYY').isSame(currentDisplayDate, 'month'));
            
            let gains = 0, expense = 0, cashFlow = 0, onlineFlow = 0;
            monthlyTransactions.forEach(tx => {
                if (tx.type === 'income') {
                    gains += tx.amount;
                    if(tx.method?.toLowerCase() === 'cash') cashFlow += tx.amount; else onlineFlow += tx.amount;
                } else {
                    expense += tx.amount;
                    if(tx.method?.toLowerCase() === 'cash') cashFlow -= tx.amount; else onlineFlow -= tx.amount;
                }
            });

            const cashBalance = startBalances.cash + cashFlow;
            const onlineBalance = startBalances.online + onlineFlow;

            document.getElementById('opening-balance').textContent = `₹${(startBalances.cash + startBalances.online).toFixed(2)}`;
            document.getElementById('monthly-gains').textContent = `₹${gains.toFixed(2)}`;
            document.getElementById('monthly-expense').textContent = `₹${expense.toFixed(2)}`;
            document.getElementById('cash-balance').textContent = `₹${cashBalance.toFixed(2)}`;
            document.getElementById('online-balance').textContent = `₹${onlineBalance.toFixed(2)}`;
            document.getElementById('closing-balance').textContent = `₹${(cashBalance + onlineBalance).toFixed(2)}`;
            console.log("DEBUG: Balances updated in DOM.");

            renderTransactions(transactionsToRender);
            console.log("DEBUG: Dashboard view update complete.");
        }

        document.getElementById('prev-month-btn').addEventListener('click', () => { 
            currentDisplayDate = viewScope === 'month' ? currentDisplayDate.subtract(1, 'month') : currentDisplayDate.subtract(1, 'day');
            updateDashboardView();
        });
        document.getElementById('next-month-btn').addEventListener('click', () => {
            currentDisplayDate = viewScope === 'month' ? currentDisplayDate.add(1, 'month') : currentDisplayDate.add(1, 'day');
            updateDashboardView();
        });
        document.getElementById('back-to-month-btn').addEventListener('click', () => {
            viewScope = 'month';
            updateDashboardView();
        });

        // --- RENDERING LOGIC --- 
        function renderTransactions(transactions) {
            const listEl = document.getElementById('transactions-list');
            listEl.innerHTML = transactions.length === 0 ? `<p id="no-transactions" class="text-[--text-secondary] text-center py-8">No transactions for this selection.</p>` : '';
            if (transactions.length === 0) return;
            
            const grouped = transactions.reduce((acc, tx) => { (acc[tx.date] = acc[tx.date] || []).push(tx); return acc; }, {});
            const sortedDates = Object.keys(grouped).sort((a, b) => dayjs(b, 'DD/MM/YYYY').valueOf() - dayjs(a, 'DD/MM/YYYY').valueOf());

            for (const date of sortedDates) {
                const dateHeader = document.createElement('div');
                dateHeader.className = 'sticky top-0 bg-[--bg-primary] py-1';
                dateHeader.innerHTML = `<h3 class="text-sm font-semibold text-[--text-secondary]">${dayjs(date, 'DD/MM/YYYY').format('D MMM YYYY, dddd')}</h3>`;
                listEl.appendChild(dateHeader);
                
                grouped[date].forEach(tx => {
                    const txEl = document.createElement('div');
                    txEl.className = 'flex items-center justify-between card p-3 rounded-lg hover:bg-[--bg-tertiary] transition-colors duration-200 cursor-pointer';
                    txEl.dataset.id = tx.id;
                    txEl.innerHTML = `<div class="flex items-center gap-4"><div><p class="font-semibold text-[--text-primary]">${tx.description}</p><p class="text-sm text-[--text-secondary] capitalize">${tx.method}</p></div></div><p class="font-bold text-lg ${tx.type === 'income' ? 'text-green-500' : 'text-red-500'}">${tx.type === 'income' ? '+' : '-'}₹${tx.amount.toFixed(2)}</p>`;
                    listEl.appendChild(txEl);
                });
            }
        }

        // --- ADD TRANSACTION FORM LOGIC ---
        const addTransactionForm = document.getElementById('add-transaction-form');
        const addDateInput = document.getElementById('add-date');
        addDateInput.value = dayjs().format('DD/MM/YYYY'); 

        addDateInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '').slice(0, 8);
            if (value.length > 4) { value = `${value.slice(0, 2)}/${value.slice(2, 4)}/${value.slice(4)}`; }
            else if (value.length > 2) { value = `${value.slice(0, 2)}/${value.slice(2)}`; }
            e.target.value = value;
        });

        async function handleAddTransaction(e) {
            e.preventDefault();
            if(!user) return alert("You must be logged in to add a transaction.");
            const data = {
                user_id: user.id,
                description: addTransactionForm.elements['add-description'].value,
                amount: parseFloat(addTransactionForm.elements['add-amount'].value),
                date: addTransactionForm.elements['add-date'].value,
                method: addTransactionForm.elements['add-method'].value,
                type: addTransactionForm.elements['add-type'].value
            };

            if (!dayjs(data.date, 'DD/MM/YYYY', true).isValid()) return alert("Invalid date format. Use DD/MM/YYYY.");
            if (!data.description || data.amount <= 0) return alert("Please fill in a valid description and amount.");

            const { error } = await supabaseClient.from('transactions').insert(data);
            
            if (error) {
                console.error("Save error:", error);
                alert("Failed to save transaction.");
            } else {
                await fetchInitialTransactions(); // This will trigger a full re-render
                const feedbackEl = document.getElementById('add-feedback');
                feedbackEl.textContent = 'Transaction added!';
                addTransactionForm.reset();
                addDateInput.value = dayjs().format('DD/MM/YYYY');
                setTimeout(() => feedbackEl.textContent = '', 3000);
            }
        }
        addTransactionForm.addEventListener('submit', handleAddTransaction);

        // --- TRANSACTION DETAIL & DELETE LOGIC ---
        const transactionsList = document.getElementById('transactions-list');
        const transactionDetailModal = document.getElementById('transaction-detail-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        
        function showTransactionDetail(txId) {
            const transaction = transactionsCache.find(tx => tx.id === txId);
            if (!transaction) return;

            transactionToDeleteId = txId; // Store the ID for potential deletion

            const detailContent = document.getElementById('transaction-detail-content');
            detailContent.innerHTML = `
                <p><span class="font-semibold text-[--text-secondary]">Description:</span> ${transaction.description}</p>
                <p><span class="font-semibold text-[--text-secondary]">Amount:</span> <span class="${transaction.type === 'income' ? 'text-green-500' : 'text-red-500'} font-bold">₹${transaction.amount.toFixed(2)}</span></p>
                <p><span class="font-semibold text-[--text-secondary]">Date:</span> ${transaction.date}</p>
                <p><span class="font-semibold text-[--text-secondary]">Method:</span> ${transaction.method}</p>
                <p><span class="font-semibold text-[--text-secondary]">Type:</span> <span class="capitalize">${transaction.type}</span></p>
            `;
            transactionDetailModal.style.display = 'flex';
        }
        
        transactionsList.addEventListener('click', (e) => {
            const txEl = e.target.closest('[data-id]');
            if (txEl) {
                const txId = parseInt(txEl.dataset.id, 10);
                showTransactionDetail(txId);
            }
        });

        document.getElementById('transaction-detail-close').addEventListener('click', () => {
            transactionDetailModal.style.display = 'none';
        });

        document.getElementById('transaction-detail-delete').addEventListener('click', () => {
            transactionDetailModal.style.display = 'none';
            deleteConfirmModal.style.display = 'flex';
        });

        document.getElementById('delete-confirm-cancel').addEventListener('click', () => {
            deleteConfirmModal.style.display = 'none';
            transactionToDeleteId = null;
        });

        document.getElementById('delete-confirm-btn').addEventListener('click', async () => {
            if (!transactionToDeleteId) return;
            
            const { error } = await supabaseClient
                .rpc('delete_transaction', { tx_id: transactionToDeleteId });

            deleteConfirmModal.style.display = 'none';

            if (error) {
                console.error("Delete error:", error);
                if (error.code === 'PGRST202') {
                    alert("Deletion failed: The required 'delete_transaction' helper function is missing in your database. Please run the setup script from the SQL editor in your Supabase project.");
                } else {
                    alert("Failed to delete transaction.");
                }
            } else {
                transactionsCache = transactionsCache.filter(tx => tx.id !== transactionToDeleteId);
                updateDashboardView();
                await fetchInitialTransactions();
            }
            transactionToDeleteId = null;
        });


        // --- DATE PICKER MODAL LOGIC ---
        const datePickerModal = document.getElementById('date-picker-modal');
        const datePickerForm = document.getElementById('date-picker-form');
        const datePickerInput = document.getElementById('date-picker-input');
        const datePickerCancel = document.getElementById('date-picker-cancel');

        monthDisplay.addEventListener('click', () => {
            datePickerInput.value = currentDisplayDate.format('YYYY-MM-DD');
            datePickerModal.style.display = 'flex';
        });
        datePickerCancel.addEventListener('click', () => {
            datePickerModal.style.display = 'none';
        });
        datePickerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            currentDisplayDate = dayjs(datePickerInput.value);
            viewScope = 'day';
            updateDashboardView();
            datePickerModal.style.display = 'none';
        });


        // --- DATA MANAGEMENT LOGIC ---
        const importFileInput = document.getElementById('import-file-input');
        const importBtn = document.getElementById('import-btn');
        const exportBtn = document.getElementById('export-btn');
        const importFeedback = document.getElementById('import-feedback');

        async function handleImport() {
            if (!user) return alert("You must be logged in to import data.");
            const file = importFileInput.files[0];
            if (!file) {
                importFeedback.textContent = 'Please select a file first.';
                importFeedback.className = 'text-sm mt-2 h-5 text-red-500';
                return;
            }

            importFeedback.textContent = 'Importing...';
            importFeedback.className = 'text-sm mt-2 h-5 text-orange-500';

            try {
                const fileContent = await file.text();
                const data = JSON.parse(fileContent);

                const summariesToUpsert = [];
                const transactionsToUpsert = [];

                for (const monthKey in data) {
                    const monthData = data[monthKey];
                    summariesToUpsert.push({
                        user_id: user.id,
                        month_key: monthKey,
                        startingCash: monthData.startingCash,
                        startingOnline: monthData.startingOnline
                    });
                    
                    monthData.transactions.forEach(tx => {
                        transactionsToUpsert.push({
                            user_id: user.id,
                            description: tx.description,
                            amount: tx.amount,
                            date: dayjs(tx.date).format('DD/MM/YYYY'),
                            method: tx.fundType,
                            type: tx.type
                        });
                    });
                }
                
                const { error: summaryError } = await supabaseClient
                    .from('monthly_summaries')
                    .upsert(summariesToUpsert, { onConflict: 'user_id, month_key' });

                if (summaryError) throw summaryError;

                const { error: txError } = await supabaseClient
                    .from('transactions')
                    .insert(transactionsToUpsert);

                if (txError) throw txError;
                
                importFeedback.textContent = 'Import successful! Refreshing data...';
                importFeedback.className = 'text-sm mt-2 h-5 text-green-500';
                
                await fetchInitialTransactions();

            } catch (error) {
                console.error("Import failed:", error);
                importFeedback.textContent = `Import failed: ${error.message}`;
                importFeedback.className = 'text-sm mt-2 h-5 text-red-500';
            } finally {
                setTimeout(() => importFeedback.textContent = '', 5000);
            }
        }

        async function handleExport() {
            if (!user) return alert("You must be logged in to export data.");

            const { data: transactions, error: txError } = await supabaseClient
                .from('transactions').select('*').eq('user_id', user.id);
            
            if (txError) return alert('Failed to fetch transactions for export.');

            const { data: summaries, error: summaryError } = await supabaseClient
                .from('monthly_summaries').select('*').eq('user_id', user.id);

            if (summaryError) return alert('Failed to fetch summaries for export.');

            const exportData = {
                transactions,
                monthly_summaries: summaries,
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aura-export-${dayjs().format('YYYY-MM-DD')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        importBtn.addEventListener('click', handleImport);
        exportBtn.addEventListener('click', handleExport);
        
        // --- STARTUP ---
        document.addEventListener('DOMContentLoaded', initializeSupabase);
    </script>
</body>
</html>


