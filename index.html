<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashflow Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9fafb; color: #1f2937; margin: 0; padding: 1rem;
        }
        .container { max-width: 896px; margin: auto; }
        header { text-align: center; margin-bottom: 2rem; }
        header h1 { font-size: 2.25rem; font-weight: 700; color: #4f46e5; }
        header p { color: #6b7280; margin-top: 0.5rem; }
        .card {
            background-color: white; padding: 1.5rem; border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 2rem;
        }
        .month-navigator { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;}
        .month-navigator h2 { font-size: 1.5rem; font-weight: 700; color: #374151; margin: 0;}
        .nav-controls { display: flex; align-items: center; gap: 0.5rem; }
        .nav-button { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 9999px; display: flex; align-items: center;}
        .nav-button:hover { background-color: #f3f4f6; }
        .nav-button svg { width: 1.5rem; height: 1.5rem; color: #6b7280; }
        .date-selector { padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        @media (min-width: 768px) { .summary-grid { grid-template-columns: repeat(3, 1fr); } }
        .summary-item { padding: 1rem; border-radius: 0.75rem; text-align: center; }
        .summary-item h3 { font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        .summary-item p { font-size: 1.5rem; font-weight: 600; margin-top: 0; }
        .bg-gray { background-color: #f3f4f6; } .text-gray { color: #4b5563; }
        .bg-green { background-color: #f0fdf4; } .text-green { color: #166534; }
        .bg-red { background-color: #fef2f2; } .text-red { color: #991b1b; }
        .bg-indigo { background-color: #eef2ff; } .text-indigo { color: #3730a3; }
        .bg-blue { background-color: #eff6ff; } .text-blue { color: #1e40af; }
        .bg-yellow { background-color: #fefce8; } .text-yellow { color: #854d0e; }
        
        .form-grid {
            display: grid; grid-template-columns: 1fr; gap: 1rem;
        }
        @media (min-width: 768px) {
            .form-grid { grid-template-columns: repeat(4, 1fr); align-items: flex-end; }
            .form-grid .form-group:nth-child(1) { grid-column: 1 / 3; } /* Description */
            .form-grid .form-button-container { grid-column: auto; }
        }

        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; }
        .form-group input, .form-group select {
            width: 100%; box-sizing: border-box; margin-top: 0.25rem; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db;
            border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); outline-color: #4f46e5;
        }
        .form-button-container { display: flex; gap: 0.5rem; }
        .form-message {
            color: #dc2626; font-size: 0.875rem; margin-top: 1rem; text-align: center;
            grid-column: 1 / -1; height: 1.25rem; opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .submit-button {
            color: white; padding: 0.5rem 1.5rem; border: none; border-radius: 0.375rem;
            font-weight: 500; cursor: pointer; transition: background-color 0.2s; width: 100%;
        }
        .btn-expense { background-color: #dc2626; } .btn-expense:hover { background-color: #b91c1c; }
        .btn-income { background-color: #16a34a; } .btn-income:hover { background-color: #15803d; }
        .transaction-list-item {
            display: flex; justify-content: space-between; align-items: center;
            background-color: #f9fafb; padding: 0.75rem; border-radius: 0.5rem;
        }
        .transaction-details { display: flex; align-items: center; gap: 1rem; }
        .transaction-type-badge { font-size: 0.875rem; font-weight: 500; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .transaction-description { font-weight: 600; }
        .transaction-date { font-size: 0.75rem; color: #6b7280; }
        .amount-expense { font-weight: 600; color: #dc2626; }
        .amount-income { font-weight: 600; color: #16a34a; }
        .delete-btn { background: none; border: none; cursor: pointer; padding: 0.375rem; border-radius: 9999px; }
        .delete-btn:hover { background-color: #fee2e2; }
        .delete-btn svg { width: 1.25rem; height: 1.25rem; color: #ef4444; }
        .empty-list-text { text-align: center; color: #6b7280; padding: 1rem 0; }
        .filter-container { display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
        .filter-container label { font-weight: 500; color: #4b5563; }
        .filter-container input { padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
        .clear-filter-btn { background-color: #e5e7eb; color: #374151; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; }
        .clear-filter-btn:hover { background-color: #d1d5db; }
        footer { 
            text-align: center; margin-top: 2rem; padding: 1rem; font-size: 0.875rem; color: #9ca3af;
            display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap;
        }
        .footer-button { background-color: transparent; border: 1px solid #d1d5db; color: #6b7280; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;}
        .footer-button:hover { background-color: #f3f4f6;}
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Cashflow Tracker</h1><p>A simple way to track your cashflow.</p></header>
        <main>
            <section class="card">
                <div class="month-navigator">
                    <h2 id="current-month-display"></h2>
                    <div class="nav-controls">
                        <select id="month-select" class="date-selector"></select>
                        <select id="year-select" class="date-selector"></select>
                        <button id="prev-month" class="nav-button"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg></button>
                        <button id="next-month" class="nav-button"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></button>
                    </div>
                </div>
                <div class="summary-grid">
                    <div class="summary-item bg-gray"><h3 class="text-gray">Opening Balance</h3><p id="opening-balance">₹0.00</p></div>
                    <div class="summary-item bg-green"><h3 class="text-green">Total Gains</h3><p id="total-gains">₹0.00</p></div>
                    <div class="summary-item bg-red"><h3 class="text-red">Total Expenses</h3><p id="total-expenses">₹0.00</p></div>
                    <div class="summary-item bg-blue"><h3 class="text-blue">Online Balance</h3><p id="online-balance">₹0.00</p></div>
                    <div class="summary-item bg-yellow"><h3 class="text-yellow">Cash Balance</h3><p id="cash-balance">₹0.00</p></div>
                    <div class="summary-item bg-indigo"><h3 class="text-indigo">Closing Balance</h3><p id="closing-balance">₹0.00</p></div>
                </div>
            </section>
            
            <section class="card">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Add a Transaction</h3>
                <form id="transaction-form">
                    <div class="form-grid">
                        <div class="form-group"><label for="description">Description</label><input type="text" id="description" required></div>
                        <div class="form-group"><label for="amount">Amount (₹)</label><input type="number" id="amount" min="0.01" step="0.01" required></div>
                        <div class="form-group"><label for="date">Date</label><input type="text" id="date" placeholder="DD/MM/YYYY" required></div>
                        <div class="form-group"><label for="fund-type">Account</label><select id="fund-type"><option value="Online">Online</option><option value="Cash">Cash</option></select></div>
                        <div class="form-button-container">
                            <button type="submit" name="income" class="submit-button btn-income">Add Income</button>
                            <button type="submit" name="expense" class="submit-button btn-expense">Add Expense</button>
                        </div>
                         <p class="form-message" id="form-message"></p>
                    </div>
                </form>
            </section>

            <section class="card">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">This Month's Transactions</h3>
                <div class="filter-container">
                    <label for="date-filter">Filter by specific date:</label>
                    <input type="date" id="date-filter">
                    <button id="clear-filter-btn" class="clear-filter-btn">Clear Filter</button>
                </div>
                <div id="transaction-list" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
            </section>
        </main>
        <footer>
            <button id="export-data" class="footer-button">Export Data</button>
            <button id="import-data" class="footer-button">Import Data</button>
            <input type="file" id="import-file-input" accept=".json" style="display: none;">
        </footer>
    </div>
<script type="module">
    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- DOM Element Selection ---
    const elements = {
        currentMonthDisplay: document.getElementById('current-month-display'),
        onlineBalance: document.getElementById('online-balance'),
        cashBalance: document.getElementById('cash-balance'),
        openingBalance: document.getElementById('opening-balance'),
        totalGains: document.getElementById('total-gains'),
        totalExpenses: document.getElementById('total-expenses'),
        closingBalance: document.getElementById('closing-balance'),
        form: document.getElementById('transaction-form'),
        transactionList: document.getElementById('transaction-list'),
        prevMonthBtn: document.getElementById('prev-month'),
        nextMonthBtn: document.getElementById('next-month'),
        formMessage: document.getElementById('form-message'),
        monthSelect: document.getElementById('month-select'),
        yearSelect: document.getElementById('year-select'),
        dateFilter: document.getElementById('date-filter'),
        clearFilterBtn: document.getElementById('clear-filter-btn'),
        exportDataBtn: document.getElementById('export-data'),
        importDataBtn: document.getElementById('import-data'),
        importFileInput: document.getElementById('import-file-input')
    };

    // --- State Management ---
    let currentDate = new Date(); 
    let allData = {};
    let app, auth, db, userId, unsubscribeFromFirestore;

    // --- Firebase Setup (these variables are injected by the environment) ---
    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAXiD1yVHFGNScOLobDOQ9dEi-Sq2u4Atc",
  authDomain: "expense-tracking-a18c8.firebaseapp.com",
  projectId: "expense-tracking-a18c8",
  storageBucket: "expense-tracking-a18c8.firebasestorage.app",
  messagingSenderId: "953094054634",
  appId: "1:953094054634:web:b8317148d491d75c7cad93",
  measurementId: "G-38RM1PQNGZ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
    
    // --- Utility Functions ---
    const getMonthKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    const formatCurrency = (amount) => `₹${amount.toFixed(2)}`;
    const formatDateForStorage = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    const formatDisplayDate = (dateString) => {
        const date = new Date(dateString);
        date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    };

    function showMessage(message, isError = true) {
        elements.formMessage.textContent = message;
        elements.formMessage.style.color = isError ? '#dc2626' : '#16a34a';
        elements.formMessage.style.opacity = 1;
        setTimeout(() => { elements.formMessage.style.opacity = 0; }, 4000);
    }
    
    const saveData = async () => {
        if (!db || !userId) {
            showMessage("Cannot save. Not connected to the cloud.", true);
            return;
        }
        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/cashflowData/main`);
            await setDoc(userDocRef, { data: JSON.stringify(allData) });
        } catch (error) {
            console.error("Error saving to Firestore:", error);
            showMessage("Failed to save data to the cloud.", true);
        }
    };
    
    const getOpeningBalance = (date) => {
        const thisMonthKey = getMonthKey(date);
        if (allData[thisMonthKey] && allData[thisMonthKey].hasOwnProperty('startingOnline')) {
            return { online: allData[thisMonthKey].startingOnline, cash: allData[thisMonthKey].startingCash };
        }
        const prevMonthDate = new Date(date);
        prevMonthDate.setDate(1);
        prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
        if (prevMonthDate.getFullYear() < 2020) return { online: 0, cash: 0 }; 
        const prevMonthKey = getMonthKey(prevMonthDate);
        const prevMonthData = allData[prevMonthKey];
        if (prevMonthData) {
            const closingOnline = (prevMonthData.transactions || []).filter(t => t.fundType === 'Online').reduce((bal, t) => bal + (t.type === 'income' ? t.amount : -t.amount), prevMonthData.startingOnline || 0);
            const closingCash = (prevMonthData.transactions || []).filter(t => t.fundType === 'Cash').reduce((bal, t) => bal + (t.type === 'income' ? t.amount : -t.amount), prevMonthData.startingCash || 0);
            return { online: closingOnline, cash: closingCash };
        } else {
            return getOpeningBalance(prevMonthDate);
        }
    };

    // --- Core Rendering Logic ---
    function renderUI() {
        try {
            const openingBalances = getOpeningBalance(currentDate);
            const monthKey = getMonthKey(currentDate);
            if (!allData[monthKey]) allData[monthKey] = { transactions: [] };
            allData[monthKey].startingOnline = openingBalances.online;
            allData[monthKey].startingCash = openingBalances.cash;
            const monthData = allData[monthKey];
            elements.currentMonthDisplay.textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            const onlineBalance = monthData.transactions.filter(t => t.fundType === 'Online').reduce((bal, t) => bal + (t.type === 'income' ? t.amount : -t.amount), monthData.startingOnline);
            const cashBalance = monthData.transactions.filter(t => t.fundType === 'Cash').reduce((bal, t) => bal + (t.type === 'income' ? t.amount : -t.amount), monthData.startingCash);
            const openingBalanceTotal = monthData.startingOnline + monthData.startingCash;
            const totalGains = monthData.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = monthData.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            elements.openingBalance.textContent = formatCurrency(openingBalanceTotal);
            elements.totalGains.textContent = formatCurrency(totalGains);
            elements.totalExpenses.textContent = formatCurrency(totalExpenses);
            elements.onlineBalance.textContent = formatCurrency(onlineBalance);
            elements.cashBalance.textContent = formatCurrency(cashBalance);
            elements.closingBalance.textContent = formatCurrency(openingBalanceTotal + totalGains - totalExpenses);
            elements.transactionList.innerHTML = '';
            const filterDate = elements.dateFilter.value;
            const transactionsToDisplay = monthData.transactions.filter(tx => !filterDate || tx.date === filterDate).sort((a, b) => new Date(b.date) - new Date(a.date));
            if (transactionsToDisplay.length === 0) {
                elements.transactionList.innerHTML = `<p class="empty-list-text">${filterDate ? 'No transactions on this date.' : 'No transactions this month!'}</p>`;
            } else {
                transactionsToDisplay.forEach(tx => {
                    const txEl = document.createElement('div');
                    txEl.className = 'transaction-list-item';
                    const fundBadgeClass = tx.fundType === 'Online' ? 'bg-blue text-blue' : 'bg-yellow text-yellow';
                    const amountClass = tx.type === 'income' ? 'amount-income' : 'amount-expense';
                    const sign = tx.type === 'income' ? '+' : '-';
                    txEl.innerHTML = `<div class="transaction-details"><span class="transaction-type-badge ${fundBadgeClass}">${tx.fundType}</span><div><p class="transaction-description">${tx.description}</p><p class="transaction-date">${formatDisplayDate(tx.date)}</p></div></div><div style="display: flex; align-items: center; gap: 1rem;"><span class="${amountClass}">${sign}${formatCurrency(tx.amount)}</span><button data-id="${tx.id}" class="delete-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div>`;
                    elements.transactionList.appendChild(txEl);
                });
            }
            elements.monthSelect.value = currentDate.getMonth();
            elements.yearSelect.value = currentDate.getFullYear();
        } catch (error) {
            console.error("Error rendering:", error);
            elements.transactionList.innerHTML = `<p class="empty-list-text" style="color: red;">A critical error occurred.</p>`;
        }
    }

    // --- Event Handlers ---
    function handleFormSubmit(event) {
        event.preventDefault();
        const type = event.submitter.name;
        const formElements = elements.form.elements;
        const description = formElements.description.value;
        const amount = parseFloat(formElements.amount.value);
        const dateInputStr = formElements.date.value.trim();
        const fundType = formElements['fund-type'].value;
        if (!description || !dateInputStr || isNaN(amount) || amount <= 0) {
            showMessage("Please fill all fields correctly."); return;
        }
        const dateParts = dateInputStr.split('/');
        let transactionDate, dateValueForStorage;
        if (dateParts.length === 3) {
            const day = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1; 
            const year = parseInt(dateParts[2], 10);
            if (!isNaN(day) && !isNaN(month) && !isNaN(year) && year > 1900 && year < 2100) {
                transactionDate = new Date(year, month, day);
                if (transactionDate.getFullYear() !== year || transactionDate.getMonth() !== month || transactionDate.getDate() !== day) {
                    showMessage("The date you entered is not valid."); return;
                }
                dateValueForStorage = formatDateForStorage(transactionDate);
            }
        }
        if (!dateValueForStorage) {
             showMessage("Please enter the date in DD/MM/YYYY format."); return;
        }
        const transactionMonthKey = getMonthKey(transactionDate);
        if (!allData[transactionMonthKey]) allData[transactionMonthKey] = { transactions: [] };
        allData[transactionMonthKey].transactions.push({ id: Date.now(), description, amount, fundType, type, date: dateValueForStorage });
        saveData();
        elements.form.reset();
        elements.form.elements.date.value = formatDisplayDate(new Date());
    }

    function handleDelete(event) {
        const deleteButton = event.target.closest('.delete-btn');
        if (deleteButton) {
            const txId = parseInt(deleteButton.dataset.id, 10);
            for (const monthKey in allData) {
                const initialLength = allData[monthKey].transactions.length;
                allData[monthKey].transactions = allData[monthKey].transactions.filter(tx => tx.id !== txId);
                if(allData[monthKey].transactions.length < initialLength) break; 
            }
            saveData();
        }
    }

    function navigateMonths(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        elements.dateFilter.value = ''; 
        renderUI();
    }
    
    function handleSelectorChange() {
        const selectedMonth = parseInt(elements.monthSelect.value);
        const selectedYear = parseInt(elements.yearSelect.value);
        currentDate = new Date(selectedYear, selectedMonth, 1);
        elements.dateFilter.value = ''; 
        renderUI();
    }
    
    function populateSelectors() {
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        elements.monthSelect.innerHTML = months.map((month, index) => `<option value="${index}">${month}</option>`).join('');
        const currentYear = new Date().getFullYear();
        let yearOptions = '';
        for (let year = currentYear - 5; year <= currentYear + 5; year++) {
            yearOptions += `<option value="${year}">${year}</option>`;
        }
        elements.yearSelect.innerHTML = yearOptions;
    }
    
    function exportData() {
        if (Object.keys(allData).length === 0) {
            showMessage("There is no data to export.", true); return;
        }
        const dataStr = JSON.stringify(allData, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'cashflow-data.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showMessage("Data exported successfully!", false);
    }

    function handleImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (typeof importedData === 'object' && importedData !== null) {
                    allData = importedData;
                    saveData(); // Save the newly imported data to the cloud
                    const firstMonth = Object.keys(allData)[0];
                    if (firstMonth) {
                        const [year, month] = firstMonth.split('-');
                        currentDate = new Date(parseInt(year), parseInt(month) - 1, 1);
                    } else {
                        currentDate = new Date();
                    }
                    renderUI();
                    showMessage("Data imported successfully!", false);
                } else {
                    throw new Error("Invalid file format");
                }
            } catch (error) {
                console.error("Error importing data:", error);
                showMessage("Could not import data. Please select a valid JSON file.", true);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    
    // --- Cloud Syncing Logic ---
    function listenForDataChanges() {
        if (unsubscribeFromFirestore) unsubscribeFromFirestore(); 

        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/cashflowData/main`);
        unsubscribeFromFirestore = onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const cloudData = JSON.parse(docSnap.data().data);
                if (JSON.stringify(allData) !== JSON.stringify(cloudData)) {
                    allData = cloudData;
                    renderUI(); 
                }
            } else {
                renderUI();
            }
        }, (error) => {
            console.error("Error listening for data:", error);
            showMessage("Lost connection to the cloud.", true);
        });
    }

    async function initializeAppAndAuth() {
        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing!");
            showMessage("Cannot connect to cloud services.", true);
            renderUI(); // Render the UI in offline mode
            return;
        }
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                listenForDataChanges();
            } else {
                try {
                    const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (authToken) {
                        await signInWithCustomToken(auth, authToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showMessage("Could not sign in. Syncing is disabled.", true);
                    renderUI(); // Render UI even if auth fails
                }
            }
        });
    }

    // --- App Initialization ---
    populateSelectors();
    elements.form.addEventListener('submit', handleFormSubmit);
    elements.transactionList.addEventListener('click', handleDelete);
    elements.prevMonthBtn.addEventListener('click', () => navigateMonths(-1));
    elements.nextMonthBtn.addEventListener('click', () => navigateMonths(1));
    elements.monthSelect.addEventListener('change', handleSelectorChange);
    elements.yearSelect.addEventListener('change', handleSelectorChange);
    elements.dateFilter.addEventListener('input', renderUI);
    elements.clearFilterBtn.addEventListener('click', () => {
        elements.dateFilter.value = '';
        renderUI();
    });
    elements.exportDataBtn.addEventListener('click', exportData);
    elements.importDataBtn.addEventListener('click', () => elements.importFileInput.click());
    elements.importFileInput.addEventListener('change', handleImport);
    
    elements.form.elements.date.value = formatDisplayDate(new Date());
    initializeAppAndAuth();
</script>
</body>
</html>


